# Распределённое программирование. Задание #8 Распределённые транзакции. Сага.
## Постановка задачи
### Ограничение пользования приложением

Количество пользователей нашего приложения увеличивается и самое время проект монетизировать. Для этого пользователи по прежнему будут иметь доступ ко всем функциям приложения, но уже в ограниченном объёме (за сутки можно оценивать не более определённого количества текстов). Для возможности пользоваться приложением сверх этого лимита пользователю предлагается приобрести платный абонемент. Замечание: на достижение лимита влияют только тексты, получившие метку *«Успешный»* (описано ниже).

### Маркировка «успешности» текста

В системе появляется понятие *Успешный* текст, который зависит от ранга (в будущем и от множества других критериев).

## Реализация
### Backend

Для реализации ограничения лимита пользования добавляется exe-компонент ***TextProcessingLimiter***, который слушает сообщения *TextCreated(contextId)* в очереди *backend-ap*i и отправляет в очередь ***processing-limiter*** сообщения ProcessingAccepted(contextId, status), в котором поле status будет иметь значение True, если компонент разрешил обработку текста, False – в противном случае. При каждом разрешении компонент уменьшает количество оставшихся запросов на обработку текста. Выданное разрешение аннулируется при получении сообщения TextSuccessMarked со значением *isSuccess==False* (описание ниже).

Компонент *TextRankCalc* вместо прежней подписки на события *TextCreated* теперь начинает слушать очередь *processing-limiter* и реагирует на сообщения *ProcessingAccepted* со значением *status==True*.

Для маркировки текста как «успешный» добавляется exe-компонент ***TextSuccessMarker***. Компонент слушает сообщения *TextRankCalculated* в очереди *text-rank-calc*. При получении сравнивает rank с заранее заданным порогом и отправляет в очередь ***text-success-marker*** сообщение **TextSuccessMarked(contextId, isSuccess)**, в котором поле *isSuccess* имеет значение True, если текст промаркирован как успешный. На сообщения *TextSuccessMarked* реагируют компоненты *TextProcessingLimiter* и *TextStatistics*.

#### Сага

В компоненте *TextProcessingLimiter* используется шаблон **«Компенсирующая транзакция»**, когда действие транзакции выдачи разрешения затем «компенсируется» в случае если текст оказался неуспешным. С помощью механизма локальных компенсирующих транзакций можно реализовывать глобальные распределённые транзакции, в которых задействовано множество компонентов. Согласно определению транзакции состояние каждого из вовлечённых компонентов должно перейти в новое в случае успешности транзакции или «не изменяться» в случае отката. «Не изменяться» в данном случае означает не откат предыдущему состоянию, как в классических транзакциях в СУБД, а «применение» новой локальной транзакции, аннулирующей предыдущие действия в рамках глобальной транзакции. Такая реализация глобальных неблокирующих транзакций с использованием локальных компенсирующих транзакций называется «Сага».

### Frontend

На странице с результатом обработки текста, на которую перенаправляется пользователь после отправки формы, нужно добавить отображение сообщения о невозможности обработки из-за достижения лимита, когда такое случается. Повышающий коэффициент 0.2, если вместо ожидания пользователю будет отображаться ход обработки: принят, отвергнут, в процессе, готово.
